<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>H·ªçc t·∫≠p: [[${course.title}]]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* T√πy ch·ªânh thanh cu·ªôn cho sidebar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        /* Style cho quiz section */
        .quiz-card {
            background: linear-gradient(145deg, #2d3748, #1e293b);
            border: 1px solid #4a5568;
        }
        .quiz-badge-easy {
            background: #10b981;
            color: white;
        }
        .quiz-badge-medium {
            background: #f59e0b;
            color: white;
        }
        .quiz-badge-hard {
            background: #ef4444;
            color: white;
        }
        .quiz-completed {
            background: linear-gradient(145deg, #059669, #10b981);
        }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 overflow-hidden">

<div class="flex h-screen flex-col md:flex-row">
    <!-- Sidebar b√™n tr√°i - Danh s√°ch b√†i h·ªçc -->
    <div class="w-full md:w-80 bg-[#1e293b] border-r border-slate-700 flex flex-col shadow-2xl">
        <div class="p-6 border-b border-slate-700 bg-[#1e293b] z-10">
            <a th:href="@{/student/my-courses}" class="text-xs font-bold text-indigo-400 uppercase tracking-widest hover:text-white transition flex items-center gap-2">
                <span>‚Üê</span> Quay l·∫°i kh√≥a h·ªçc
            </a>
            <h1 class="mt-4 font-black text-white text-lg leading-tight" th:text="${course.title}">T√™n kh√≥a h·ªçc</h1>

            <div class="mt-4 flex items-center gap-2">
                <div class="flex-1 bg-slate-700 h-1.5 rounded-full overflow-hidden">
                    <div class="bg-indigo-500 h-full transition-all duration-500"
                         th:style="'width: ' + ${enrollment.progressPercentage} + '%'"></div>
                </div>
                <span class="text-[10px] font-bold text-slate-400" th:text="${#numbers.formatDecimal(enrollment.progressPercentage, 0, 0) + '%'}">0%</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
            <div th:each="lesson, i : ${course.lessons}"
                 class="lesson-item p-4 rounded-2xl hover:bg-slate-700/50 cursor-pointer transition border border-transparent hover:border-slate-600 group"
                 th:data-id="${lesson.id}"
                 th:data-video="${lesson.videoUrl}"
                 th:data-title="${lesson.title}"
                 th:data-quiz-id="${lesson.quiz != null ? lesson.quiz.id : ''}"
                 th:data-quiz-completed="${completedQuizzes != null ? completedQuizzes.contains(lesson.quiz?.id) : false}"
                 onclick="handleLessonClick(this)">

                <div class="flex items-start gap-3">
                    <div class="bg-slate-800 text-slate-500 w-6 h-6 rounded-lg flex items-center justify-center text-[10px] font-bold group-hover:bg-indigo-500 group-hover:text-white transition-colors" th:text="${i.count}">
                        1
                    </div>
                    <div class="flex-1">
                        <span class="text-[10px] font-black text-slate-500 block mb-1 uppercase tracking-wider">B√†i h·ªçc</span>
                        <span class="text-sm font-bold group-hover:text-white leading-snug block" th:text="${lesson.title}">Ti√™u ƒë·ªÅ b√†i h·ªçc</span>

                        <!-- Hi·ªÉn th·ªã tr·∫°ng th√°i quiz -->
                        <div th:if="${lesson.quiz != null}" class="mt-2">
                            <span th:if="${completedQuizzes != null and completedQuizzes.contains(lesson.quiz.id)}"
                                  class="text-[10px] bg-emerald-600 text-white px-2 py-0.5 rounded-full font-bold">
                                ‚úÖ ƒê√£ l√†m quiz
                            </span>
                            <span th:unless="${completedQuizzes != null and completedQuizzes.contains(lesson.quiz.id)}"
                                  class="text-[10px] bg-amber-600 text-white px-2 py-0.5 rounded-full font-bold">
                                üìù Quiz
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Khu v·ª±c ch√≠nh b√™n ph·∫£i -->
    <div class="flex-1 flex flex-col h-full overflow-hidden">
        <!-- Video player -->
        <div class="flex-1 bg-black relative flex items-center justify-center">
            <iframe id="youtube-player"
                    class="w-full h-full hidden"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
            </iframe>

            <div id="video-placeholder" class="absolute inset-0 flex items-center justify-center text-center bg-slate-900">
                <div class="max-w-sm px-6">
                    <div class="w-20 h-20 bg-indigo-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-indigo-500/50 animate-bounce">
                        <span class="text-3xl text-white">‚ñ∂</span>
                    </div>
                    <h2 class="text-xl font-bold text-white">S·∫µn s√†ng h·ªçc t·∫≠p?</h2>
                    <p class="text-slate-500 mt-2">H√£y ch·ªçn m·ªôt b√†i h·ªçc t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu b√†i gi·∫£ng ngay nh√©!</p>
                </div>
            </div>
        </div>

        <!-- Thanh ƒëi·ªÅu khi·ªÉn -->
        <div class="bg-[#1e293b] px-8 py-4 flex justify-between items-center border-t border-slate-700">
            <div class="flex flex-col">
                <span id="current-lesson-label" class="text-[10px] font-black text-slate-500 uppercase tracking-widest">ƒêang ph√°t</span>
                <span id="current-lesson-title" class="font-bold text-indigo-400">Vui l√≤ng ch·ªçn b√†i h·ªçc...</span>
            </div>

            <div class="flex gap-3">
                <!-- N√∫t l√†m quiz -->
                <a id="btn-quiz" href="#"
                   class="hidden bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-black uppercase text-xs transition-all shadow-lg shadow-indigo-900/20 active:scale-95 items-center gap-2">
                    <span>üìù</span> L√†m quiz
                </a>

                <!-- N√∫t ho√†n th√†nh b√†i h·ªçc -->
                <button onclick="markAsCompleted()" id="btn-complete"
                        class="hidden bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-3 rounded-xl font-black uppercase text-xs transition-all shadow-lg shadow-emerald-900/20 active:scale-95">
                    ‚úî Ho√†n th√†nh b√†i h·ªçc
                </button>
            </div>
        </div>

        <!-- Ph·∫ßn n·ªôi dung b√™n d∆∞·ªõi -->
        <div class="p-8 bg-[#0f172a] border-t border-slate-800 overflow-y-auto h-[30vh] custom-scrollbar">
            <div class="max-w-4xl">
                <!-- M√¥ t·∫£ b√†i h·ªçc -->
                <div id="lesson-description" class="mb-8">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <span class="w-2 h-6 bg-indigo-500 rounded-full"></span>
                        M√¥ t·∫£ b√†i h·ªçc
                    </h3>
                    <p id="lesson-content" class="text-slate-400 leading-relaxed" th:text="${course.description}">
                        M√¥ t·∫£ kh√≥a h·ªçc s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y...
                    </p>
                </div>

                <!-- K·∫øt qu·∫£ quiz (n·∫øu ƒë√£ l√†m) -->
                <div id="quiz-result" class="hidden">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <span class="w-2 h-6 bg-emerald-500 rounded-full"></span>
                        K·∫øt qu·∫£ quiz
                    </h3>
                    <div class="quiz-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-emerald-400 font-bold text-lg" id="quiz-score">0/10</span>
                            <span id="quiz-difficulty" class="px-3 py-1 rounded-full text-xs font-bold">D·ªÖ</span>
                        </div>
                        <p id="quiz-feedback" class="text-slate-300 text-sm">Ch∆∞a c√≥ ƒë√°nh gi√°</p>
                        <a id="review-quiz-link" href="#" class="mt-4 inline-block text-indigo-400 text-sm hover:underline">
                            Xem chi ti·∫øt ‚Üí
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    let currentLessonId = null;
    let currentQuizId = null;
    let currentQuizCompleted = false;
    const enrollmentId = [[${enrollment.id}]];

    // D·ªØ li·ªáu quiz k·∫øt qu·∫£ (n·∫øu c√≥)
    const quizAttempts = [[${quizAttempts}]];
    const completedQuizzes = [[${completedQuizzes}]];

    /**
     * H√†m x·ª≠ l√Ω khi click v√†o item b√†i h·ªçc
     */
    function handleLessonClick(element) {
        const id = element.getAttribute('data-id');
        const videoId = element.getAttribute('data-video');
        const title = element.getAttribute('data-title');
        const quizId = element.getAttribute('data-quiz-id');
        const quizCompleted = element.getAttribute('data-quiz-completed') === 'true';

        // C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
        currentLessonId = id;
        currentQuizId = quizId;
        currentQuizCompleted = quizCompleted;

        // C·∫≠p nh·∫≠t giao di·ªán active
        document.querySelectorAll('.lesson-item').forEach(item => {
            item.classList.remove('bg-slate-700/80', 'border-slate-500');
        });
        element.classList.add('bg-slate-700/80', 'border-slate-500');

        // Play video
        playVideo(videoId, title);

        // C·∫≠p nh·∫≠t n√∫t quiz
        updateQuizButton();

        // C·∫≠p nh·∫≠t k·∫øt qu·∫£ quiz (n·∫øu c√≥)
        updateQuizResult();
    }

    /**
     * H√†m load video YouTube v√†o iframe
     */
    function playVideo(videoId, title) {
        const player = document.getElementById('youtube-player');
        const placeholder = document.getElementById('video-placeholder');
        const btnComplete = document.getElementById('btn-complete');
        const titleDisplay = document.getElementById('current-lesson-title');

        if (videoId && videoId !== 'null') {
            // T·∫°o URL YouTube Embed
            player.src = "https://www.youtube.com/embed/" + videoId + "?autoplay=1&rel=0";
            player.classList.remove('hidden');
            placeholder.classList.add('hidden');
            btnComplete.classList.remove('hidden');
            titleDisplay.innerText = title;
        } else {
            // Kh√¥ng c√≥ video
            player.classList.add('hidden');
            placeholder.classList.remove('hidden');
            btnComplete.classList.add('hidden');
            titleDisplay.innerText = 'B√†i h·ªçc kh√¥ng c√≥ video';
        }
    }

    /**
     * C·∫≠p nh·∫≠t n√∫t quiz d·ª±a tr√™n tr·∫°ng th√°i
     */
    function updateQuizButton() {
        const btnQuiz = document.getElementById('btn-quiz');

        if (currentQuizId && currentQuizId !== '') {
            btnQuiz.classList.remove('hidden');

            if (currentQuizCompleted) {
                btnQuiz.innerHTML = '<span>üìã</span> Xem l·∫°i quiz';
                btnQuiz.classList.remove('bg-indigo-600', 'hover:bg-indigo-500');
                btnQuiz.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
            } else {
                btnQuiz.innerHTML = '<span>üìù</span> L√†m quiz';
                btnQuiz.classList.remove('bg-emerald-600', 'hover:bg-emerald-500');
                btnQuiz.classList.add('bg-indigo-600', 'hover:bg-indigo-500');
            }

            btnQuiz.href = `/student/quiz/` + currentQuizId + `/take`;
        } else {
            btnQuiz.classList.add('hidden');
        }
    }

    /**
     * C·∫≠p nh·∫≠t hi·ªÉn th·ªã k·∫øt qu·∫£ quiz
     */
    function updateQuizResult() {
        const quizResultDiv = document.getElementById('quiz-result');
        const lessonDescDiv = document.getElementById('lesson-description');

        if (currentQuizCompleted && quizAttempts) {
            // T√¨m k·∫øt qu·∫£ quiz hi·ªán t·∫°i
            const attempt = quizAttempts.find(a => a.quiz.id == currentQuizId);

            if (attempt) {
                document.getElementById('quiz-score').innerText = attempt.score + '/' + attempt.totalQuestions;
                document.getElementById('quiz-difficulty').innerText = attempt.quiz.difficulty;
                document.getElementById('quiz-feedback').innerText = attempt.aiFeedback || 'Ch∆∞a c√≥ ƒë√°nh gi√°';
                document.getElementById('review-quiz-link').href = `/student/quiz/result/` + attempt.id;

                quizResultDiv.classList.remove('hidden');
                lessonDescDiv.classList.add('hidden');
                return;
            }
        }

        // Kh√¥ng c√≥ k·∫øt qu·∫£, hi·ªÉn th·ªã m√¥ t·∫£
        quizResultDiv.classList.add('hidden');
        lessonDescDiv.classList.remove('hidden');
    }

    /**
     * H√†m g·ªçi API c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô h·ªçc t·∫≠p
     */
    function markAsCompleted() {
        if (!currentLessonId) {
            alert("Vui l√≤ng ch·ªçn b√†i h·ªçc tr∆∞·ªõc!");
            return;
        }

        const btn = document.getElementById('btn-complete');
        btn.innerText = "ƒêang x·ª≠ l√Ω...";
        btn.disabled = true;

        fetch(`/student/api/lesson/${currentLessonId}/complete?enrollmentId=${enrollmentId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Th√™m CSRF Token n·∫øu Spring Security c·ªßa b·∫°n ƒëang b·∫≠t CSRF
                // 'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
            }
        })
            .then(response => {
                if(response.ok) {
                    btn.innerText = "ƒê√£ l∆∞u ti·∫øn ƒë·ªô!";
                    btn.classList.replace('bg-emerald-600', 'bg-indigo-600');

                    setTimeout(() => {
                        location.reload(); // Reload ƒë·ªÉ c·∫≠p nh·∫≠t thanh ti·∫øn ƒë·ªô (%)
                    }, 1000);
                } else {
                    alert("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô.");
                    btn.innerText = "‚úî Ho√†n th√†nh b√†i h·ªçc";
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                btn.innerText = "‚úî Ho√†n th√†nh b√†i h·ªçc";
                btn.disabled = false;
            });
    }

    // Kh·ªüi t·∫°o b√†i h·ªçc ƒë·∫ßu ti√™n khi trang load
    document.addEventListener('DOMContentLoaded', function() {
        const firstLesson = document.querySelector('.lesson-item');
        if (firstLesson) {
            firstLesson.click();
        }
    });
</script>

</body>
</html>